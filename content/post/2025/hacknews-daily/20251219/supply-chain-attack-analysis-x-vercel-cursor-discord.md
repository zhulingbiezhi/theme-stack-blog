---
title: "供应链攻击剖析：我们如何通过一个依赖包攻陷X、Vercel、Cursor和Discord"
date: 2025-12-19
tags:
  - "供应链安全"
  - "Node.js"
  - "渗透测试"
  - "安全研究"
  - "开源安全"
categories:
  - "网络安全"
draft: false
description: "本文深入解析了一次针对流行开源依赖包的供应链攻击，攻击者通过劫持一个名为 `@x.com` 的 npm 包，成功渗透了 X、Vercel、Cursor 和 Discord 等知名科技公司的内部系统。文章不仅还原了攻击链，更从防御者视角剖析了现代软件供应链的脆弱性，并为开发者和安全团队提供了切实可行的防护策略。"
slug: "supply-chain-attack-analysis-x-vercel-cursor-discord"
---

## 文章摘要

本文深度剖析了一起极具代表性的现代软件供应链攻击案例。安全研究员通过劫持一个名为 `@x.com` 的 npm 包，利用其作为跳板，成功渗透了包括 X（原 Twitter）、Vercel、Cursor 和 Discord 在内的多家顶级科技公司的内部系统。攻击的核心在于利用这些公司内部工具或构建流程中对该包的依赖，从而在受信环境中执行任意代码。文章不仅详细展示了从包劫持、载荷投递到横向移动的完整攻击链，更深刻揭示了当前开源生态中依赖管理的巨大风险。对于开发者、DevOps 工程师和安全从业者而言，本文是一份关于供应链攻击原理、危害及防御策略的绝佳教材。

## 背景与问题

在当今以“快速迭代”和“代码复用”为核心的软件开发范式下，开源依赖已成为应用程序不可或缺的基石。以 Node.js 生态为例，一个项目动辄依赖成百上千个第三方包。这种模式极大地提升了开发效率，但也引入了一个致命的风险点：**软件供应链安全**。供应链攻击是指攻击者通过污染软件交付链中的某个环节（如开源库、构建工具、更新服务器）来间接攻击最终目标。与直接攻击目标系统相比，这种方式往往更隐蔽、波及面更广，且能轻易绕过传统的边界安全防御。

本次事件的主角 `@x.com` 包，其名称巧妙地模仿了 X（原 Twitter）的域名，这并非偶然。许多大型公司会内部发布和使用以自己域名为范围的私有包，用于共享工具、配置或 SDK。攻击者正是利用了这种模式：他们抢注了 `@x.com` 这个公共 npm 包名，并寄希望于某些公司内部存在引用公共 `@x.com` 而非私有仓库中同名包的“错误配置”或“历史遗留代码”。一旦有内部构建系统或工具安装了这个恶意包，攻击者的代码就能在以高权限运行的 CI/CD 流水线或开发者机器上执行，从而获得初始立足点。

这个案例暴露出的核心问题是多层次的：**依赖混淆攻击**的可行性、**内部依赖管理**的混乱、**CI/CD 环境**的过度信任，以及开源生态中**包命名空间缺乏有效治理**。理解这次攻击，对于任何依赖开源组件的组织都至关重要，它不再是一个遥远的理论威胁，而是已经发生的现实风险。

## 核心内容解析

### 核心观点提取

**1. 依赖混淆是供应链攻击的利器**
攻击者通过抢注与目标公司内部私有包同名的公共包，诱使构建系统错误地拉取恶意版本。这种攻击成功率的高低，直接反映了目标公司依赖管理流程的成熟度。其重要性在于，它利用了自动化流程的信任，而非某个具体的技术漏洞。

**2. 构建环境是通往核心资产的“黄金门票”**
CI/CD 流水线、内部工具链通常拥有访问源代码仓库、生产环境密钥、内部网络等高权限。一旦攻击代码在此执行，其权限级别往往远高于攻陷一个普通 Web 服务器。这凸显了保护构建和部署管道安全的极端重要性。

**3. 攻击载荷的隐蔽性与持久化是关键**
文章中攻击者使用的并非简单的反向 Shell，而是通过 DNS 隧道等隐蔽通道外传数据，并尝试在受害机器上建立持久化访问。这表明现代攻击已高度专业化，旨在长期潜伏而非一次性破坏。

**4. 横向移动能力决定攻击影响范围**
在获得 Vercel 等环境的访问权后，攻击者能够遍历项目、访问环境变量、甚至尝试向其他项目部署恶意代码。这展示了在云原生和微服务架构下，一个点的突破可能迅速演变为对整个平台或大量客户数据的威胁。

**5. 响应与漏洞赏金的伦理边界**
攻击者在成功渗透后主动报告了漏洞，并获得了可观的赏金。这引发了关于“攻击性安全研究”伦理的讨论：多深入的测试是可接受的？如何在证明危害的同时最小化风险？

### 技术深度分析

本次攻击的技术链条清晰展示了现代供应链攻击的典型手法：

**第一阶段：包劫持与投递**
攻击者注册了 `@x.com` 这个 npm 包。关键在于，他们发布的包版本号采用了极高的数字（如 `999.999.999`）。在 Node.js 的语义化版本控制（SemVer）中，当依赖声明为 `*`、`latest` 或 `^x.x.x` 时，高版本号会被优先安装。如果目标内部存在类似 `"@x.com": "*"` 的宽松依赖声明，系统就会自动拉取这个恶意的最新版。

恶意包的 `package.json` 中定义了 `install` 或 `postinstall` 脚本，这些脚本会在包安装时自动执行。这是 npm/yarn 提供的合法功能，但在此被武器化。

```json
{
  "name": "@x.com",
  "version": "999.999.999",
  "scripts": {
    "postinstall": "node .postinstall.js"
  }
}
```

**第二阶段：初始访问与侦察**
`.postinstall.js` 中的代码是攻击载荷。它首先会进行环境侦察，收集主机名、当前用户名、环境变量（其中常包含敏感密钥）、`package.json` 内容以及当前工作目录的文件列表。这些信息帮助攻击者判断所处环境的价值（是开发者笔记本、测试服务器还是生产构建机）。

**第三阶段：隐蔽外联与数据渗出**
为了避免触发基于 IP 或域名的警报，攻击者采用了 **DNS 隧道技术** 进行数据渗出。他们将收集到的数据编码为十六进制字符串，然后将其分割并作为子域名的一部分，向攻击者控制的 DNS 服务器发起查询。

例如，数据 `secret_key=abc123` 被编码为 `7365637265745f6b65793d616263313233`，然后构造如 `7365.attacker-domain.com`、`6372.attacker-domain.com` 等一系列 DNS 查询。攻击者的 DNS 服务器会记录这些查询，从而重组出原始数据。这种方式通常能绕过只监控 HTTP/HTTPS 流量的安全系统。

**第四阶段：横向移动与持久化**
在确认环境有价值后（如识别出 Vercel、AWS 等环境变量），攻击者会尝试进一步行动。例如，他们可能：
1.  利用窃取的 API 令牌（如 Vercel 的 `VERCEL_TOKEN`）访问云平台 API，枚举项目、部署甚至尝试创建新的恶意部署。
2.  在系统中植入后门，如创建计划任务（cron job）或修改 shell 配置文件（`.bashrc`, `.zshrc`），以确保在初始访问点失效后仍能维持控制。
3.  尝试访问同一网络环境下的其他服务，进行内部网络侦察。

### 实践应用场景

**对于安全工程师**：
此案例是进行内部供应链安全审计的绝佳模板。可以模拟测试：公司内部是否存在可能被混淆的私有包名？CI/CD 流水线中安装依赖的流程是否强制了来源（如只允许从私有仓库安装）？构建环境是否进行了严格的网络出口过滤和权限最小化？

**对于开发与 DevOps 团队**：
必须严格规范依赖声明。禁止在 `package.json` 中使用通配符 `*` 作为版本号。对于内部包，应通过 `.npmrc` 文件将 `@company` 范围明确指向私有仓库地址。在 CI 脚本中，考虑使用 `npm ci` 或 `yarn install --frozen-lockfile`，确保安装完全基于锁文件（`package-lock.json` 或 `yarn.lock`），防止意外安装新包或新版本。

**对于开源项目维护者**：
即使项目不直接涉及敏感数据，也应意识到自己的项目可能成为攻击者投毒的“上游”。应启用 npm 的**双因素认证（2FA）**，定期审计维护者账号，并考虑使用自动化工具扫描依赖中的已知漏洞。

## 深度分析与思考

### 文章价值与意义

这篇文章的价值远超一个简单的漏洞报告。它是一份**全景式的供应链攻击实战记录**，为安全社区提供了极其珍贵的一手资料。其意义在于：
1.  **教育意义**：它用真实案例生动展示了“依赖混淆”等相对抽象的攻击手法如何在实际中奏效，比任何理论描述都更具冲击力。
2.  **行业警示**：它向所有科技公司，尤其是那些严重依赖开源和自动化流程的公司，敲响了最响亮的警钟。即使是 X、Vercel 这样技术领先的公司也存在此类防御缺口，其他公司更应引以为戒。
3.  **方法论贡献**：文章详细披露了攻击者的思维过程、工具选择和绕过技巧，为防御方改进检测和响应策略提供了明确的线索。例如，监控 DNS 日志中的异常长子域名查询，成为检测此类攻击的有效手段。

### 对读者的实际应用价值

对于读者，本文的价值在于将安全意识转化为可执行的**安全实践**：
- **技能提升**：读者将深入理解供应链攻击的生命周期，从攻击面识别、载荷构造到横向移动，从而能够更好地进行威胁建模和渗透测试。
- **问题解决**：本文直接帮助解决“如何保护我的组织免受类似攻击”的问题。读者可以立即着手检查项目的依赖声明、加固 CI/CD 管道、实施网络分段和出口过滤。
- **职业发展**：掌握软件供应链安全知识已成为安全工程师、云架构师甚至高级开发者的核心竞争力。理解本次攻击的细节，将使你在设计安全开发流程（DevSecOps）时更具前瞻性和深度。

### 可能的实践场景

1.  **内部红队演练**：以本文为蓝本，组织内部的红队可以尝试发起一次受控的、经过授权的依赖混淆攻击，以测试公司从开发到部署全流程的防御能力。这是检验安全控制有效性的最佳方式。
2.  **制定依赖管理策略**：推动公司制定强制性的依赖管理策略，包括：必须使用锁文件、所有包（包括间接依赖）必须经过安全扫描、禁止使用公共仓库获取内部范围包等。
3.  **工具链集成**：在 CI/CD 流水线中集成像 `npm audit`、`yarn audit`、`snyk` 或 `OSS Index` 这样的依赖安全检查工具，并将其设置为阻断性关卡，存在高风险漏洞的构建不予通过。
4.  **监控与检测**：安全运营团队应建立针对构建环境的特殊监控。例如，监控从构建容器发起的异常网络连接（尤其是 DNS 查询）、非预期的子进程创建、对敏感文件（如 `.env`, `*.pem`）的读取尝试等。

### 个人观点与思考

这次攻击成功最令人深思的一点是，它利用的并非“零日漏洞”，而是**流程缺陷和配置错误**。这指向了安全领域的一个根本性挑战：技术控制可以不断升级，但人与流程的复杂性使得完美的安全遥不可及。

从防御角度看，我们需要从“完全预防”转向“快速检测和响应”。假设攻击不可避免，那么构建环境应被设计成**短暂且无状态的**。每次构建都在一个全新的、最小化的容器中运行，任务完成后立即销毁。这样即使被植入恶意代码，其生存时间也极短，难以建立持久化。同时，所有构建日志、网络流量必须被详细记录和分析。

此外，开源生态需要更根本的变革。npm 等包管理器是否应该对 `@` 开头的范围化包名实施更严格的验证？是否应该引入类似于域名所有权的验证机制，防止此类“抢注”？社区正在探索的解决方案，如 **Sigstore** 用于代码签名，**GUAC** 用于生成软件物料清单（SBOM），都是朝着增强供应链透明度和可追溯性的正确方向。

最后，关于漏洞赏金计划的伦理，我认为研究者的行为在本次事件中总体是负责任的。他们在证明漏洞后及时报告，并删除了恶意包。一个健康的生态系统需要这样“以攻促防”的研究。赏金计划应当制定更清晰的规则，明确允许的测试范围（例如，禁止对客户数据或生产服务进行实际读写操作），为安全研究者提供合法的发挥空间，共同筑牢防线。

## 技术栈/工具清单

本次攻击与防御涉及的技术栈是多方面的：

**攻击方技术栈**：
- **包管理平台**：npm (Node Package Manager)，用于发布恶意包 `@x.com`。
- **脚本语言**：Node.js，用于编写在 `postinstall` 阶段执行的攻击载荷。
- **隐蔽通道**：DNS 协议，用于构建隧道渗出数据，规避传统网络监控。
- **命令与控制（C2）**：攻击者自控的 DNS 服务器，用于接收并解码渗出的数据。
- **云服务 API**：利用窃取的令牌（如 Vercel API Token、AWS Credentials）与云平台交互，进行横向移动。

**防御方相关技术/工具**：
- **依赖扫描与审计**：`npm audit` / `yarn audit` (内置)、[Snyk](https://snyk.io/)、[GitHub Dependabot](https://docs.github.com/en/code-security/dependabot)、[OWASP Dependency-Check](https://owasp.org/www-project-dependency-check/)。
- **软件成分分析（SCA）**：用于生成和分析软件物料清单（SBOM）的工具，如 [Syft](https://github.com/anchore/syft)、[Trivy](https://github.com/aquasecurity/trivy)。
- **CI/CD 安全**：GitHub Actions, GitLab CI, Jenkins 等的安全加固配置，以及专用安全工具如 [Checkmarx](https://checkmarx.com/)、[SonarQube](https://www.sonarsource.com/)。
- **网络监控与检测**：能够深度解析 DNS 流量并检测异常模式的安全信息与事件管理（SIEM）系统，如 Splunk、Elastic SIEM，以及网络检测与响应（NDR）工具。
- **供应链完整性工具**：用于代码签名和验证的 [Sigstore](https://www.sigstore.dev/)，用于供应链安全策略执行的 [in-toto](https://in-toto.io/)。

## 相关资源与延伸阅读

1.  **原始报告**：[We pwned X, Vercel, Cursor, and Discord through a supply-chain attack](https://gist.github.com/hackermondev/5e2cdc32849405fff6b46957747a2d28) - 本文分析的源头，必读。
2.  **官方文档与指南**：
    - [npm 安全最佳实践](https://docs.npmjs.com/best-practices) - npm 官方提供的安全建议。
    - [OWASP 软件供应链攻击指南](https://owasp.org/www-project-software-supply-chain-security/) - OWASP 关于软件供应链安全的全面资源。
    - [SLSA (Supply-chain Levels for Software Artifacts) 框架](https://slsa.dev/) - Google 发起的一个安全框架，用于确保软件制品在整个供应链中的完整性。
3.  **深度分析文章**：
    - [“依赖混淆”攻击的经典论文与案例](https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610) - 最早系统性阐述依赖混淆攻击的文章之一。
    - [SolarWinds 事件深度分析](https://www.mandiant.com/resources/blog/evolving-software-supply-chain-attacks) - 了解史上影响最广的供应链攻击之一。
4.  **实用工具与社区**：
    - [Socket.dev](https://socket.dev/) - 一款专注于检测开源包中安全风险的扫描器，能检测安装脚本、混淆代码等行为。
    - [OpenSSF (Open Source Security Foundation)](https://openssf.org/) - Linux 基金会下的开源安全基金会，汇集了大量供应链安全项目与资源。
    - [GitHub Security Lab](https://securitylab.github.com/) - GitHub 的安全研究团队，发布许多关于开源安全的洞见和工具。

## 总结

本次针对 `@x.com` 包的供应链攻击事件，如同一面镜子，清晰地映照出现代软件开发在效率与安全之间的深刻矛盾。攻击者巧妙地利用了开源依赖机制的信任、自动化流程的权限以及内部配置的疏忽，完成了一次对多家顶尖科技公司的深度渗透。它有力地证明，供应链安全已从理论风险升级为迫在眉睫的实战威胁。

文章的核心启示在于，防御此类攻击不能仅靠单点技术，而需要一个**体系化的策略**。这包括：严格的依赖声明与锁文件使用、构建环境的隔离与最小权限原则、全面的依赖漏洞扫描、对异常网络行为（尤其是DNS）的监控，以及对整个软件物料清单（SBOM）的透明化管理。

作为开发者或安全从业者，我们的下一步行动应该是：立即审视自己项目的 `package.json`，收紧版本约束；推动团队采纳 `npm ci` 和强制锁文件策略；并开始讨论如何将 Sigstore、SLSA 等先进框架集成到开发流水线中。在这个由开源软件驱动的时代，守护供应链的安全，就是守护我们数字世界的基石。