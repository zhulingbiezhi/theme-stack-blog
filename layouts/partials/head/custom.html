<!-- 字体加载优化：避免字体闪烁 -->
<script>
(function() {
    // 初始状态：使用备用字体，避免闪烁
    document.documentElement.classList.add('fonts-loading');
    
    // 检测字体是否已加载
    if ('fonts' in document) {
        // 等待字体 CSS 加载完成
        function checkFontLoaded() {
            // 检查字体是否可用
            if (document.fonts.check('1em "LXGW WenKai Screen"')) {
                document.documentElement.classList.remove('fonts-loading');
                document.documentElement.classList.add('fonts-loaded');
                return true;
            }
            return false;
        }
        
        // 立即检查一次
        if (!checkFontLoaded()) {
            // 如果字体未加载，等待加载
            document.fonts.ready.then(function() {
                checkFontLoaded();
            });
            
            // 主动加载字体
            document.fonts.load('1em "LXGW WenKai Screen"').then(function() {
                document.documentElement.classList.remove('fonts-loading');
                document.documentElement.classList.add('fonts-loaded');
            }).catch(function() {
                // 字体加载失败，使用备用字体
                document.documentElement.classList.remove('fonts-loading');
                document.documentElement.classList.add('fonts-fallback');
            });
            
            // 设置超时，避免无限等待
            setTimeout(function() {
                if (document.documentElement.classList.contains('fonts-loading')) {
                    document.documentElement.classList.remove('fonts-loading');
                    if (!checkFontLoaded()) {
                        document.documentElement.classList.add('fonts-fallback');
                    }
                }
            }, 3000); // 3秒超时
        }
    } else {
        // 不支持 Font Loading API，使用备用字体
        document.documentElement.classList.remove('fonts-loading');
        document.documentElement.classList.add('fonts-fallback');
    }
})();
</script>

<!-- 自动语言检测和跳转脚本 -->
<script>
    (function() {
        // 检测是否为搜索引擎爬虫
        var userAgent = navigator.userAgent.toLowerCase();
        var isCrawler = /bot|crawler|spider|crawling|googlebot|bingbot|yandex|baiduspider|facebookexternalhit|twitterbot|rogerbot|linkedinbot|embedly|quora link preview|showyoubot|outbrain|pinterest|slackbot|vkshare|w3c_validator|whatsapp|lighthouse/i.test(userAgent);
        
        // 如果是爬虫，不执行跳转
        if (isCrawler) {
            return;
        }
        
        // 检查是否已经手动选择过语言（使用 localStorage 保存用户偏好）
        var userPreferredLang = localStorage.getItem('userPreferredLang');
        
        // 如果用户已经手动选择过语言，则不自动跳转
        if (userPreferredLang) {
            return;
        }
        
        // 获取浏览器语言设置
        var browserLang = navigator.language || navigator.userLanguage;
        var currentPath = window.location.pathname;
        
        // 检测中文语言（包括 zh, zh-CN, zh-TW 等）
        var isChineseBrowser = browserLang.toLowerCase().startsWith('zh');
        
        // 检测当前页面语言
        var isEnglishPage = currentPath.startsWith('/en/');
        var isChinesePage = !isEnglishPage; // 默认中文
        
        // 如果浏览器是中文但当前是英文页面，尝试跳转到中文版本
        if (isChineseBrowser && isEnglishPage) {
            var chinesePath = currentPath.replace(/^\/en\//, '/');
            // 使用 replace 而不是 href，这样不会在历史记录中留下额外记录
            window.location.replace(chinesePath);
        }
        // 如果浏览器不是中文但当前是中文页面，尝试跳转到英文版本
        else if (!isChineseBrowser && isChinesePage && currentPath !== '/') {
            var englishPath = '/en' + currentPath;
            window.location.replace(englishPath);
        }
    })();
</script>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script defer src="https://us.umami.is/script.js" data-website-id="d501d708-5722-4653-be01-e0919e4163fd"></script>
<!-- AdSense 延迟加载 -->
<script>
  window.addEventListener('load', function() {
    setTimeout(function() {
      var adsScript = document.createElement('script');
      adsScript.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6812677205018200';
      adsScript.async = true;
      adsScript.crossOrigin = 'anonymous';
      document.head.appendChild(adsScript);
    }, 2000); // 页面加载完成后 2 秒再加载广告
  });
</script>