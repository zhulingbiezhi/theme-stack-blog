# 渲染阻塞资源优化说明

## 优化概述

针对网站初始渲染被阻塞 1,310 毫秒的问题，实施了以下优化措施，预计可显著改善 LCP (Largest Contentful Paint) 和 FCP (First Contentful Paint) 指标。

## 优化措施

### 1. CDN 预连接优化

**文件**: `layouts/partials/head/head.html`

添加了对主要 CDN 的 DNS 预解析和预连接：
- `unpkg.com` - 用于 Waline、PhotoSwipe、Vibrant 等库
- `cdn.jsdelivr.net` - 用于 Mermaid、KaTeX 等库

```html
<link rel="dns-prefetch" href="https://unpkg.com">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
```

**效果**: 提前建立 TCP 连接，减少后续资源加载延迟

### 2. 关键 CSS 预加载

**文件**: `layouts/partials/head/style.html`

为主样式表添加 preload 提示：
```html
<link rel="preload" href="{{ $style.RelPermalink }}" as="style">
```

**效果**: 提高关键 CSS 的加载优先级

### 3. Waline 评论系统懒加载

**文件**: `layouts/partials/comments/provider/waline.html`

**优化前**: Waline CSS (29.1 KiB) 在页面加载时立即请求，阻塞渲染 3,440 毫秒

**优化后**: 
- 使用 Intersection Observer API 实现懒加载
- 仅当评论区进入视口 200px 范围内时才加载
- CSS 和 JS 动态加载，不阻塞初始渲染
- 提供降级方案支持旧浏览器

**预计节省**: ~3,440 毫秒（对于不滚动到评论区的用户）

### 4. Mermaid 图表库延迟加载

**文件**: `layouts/partials/helper/mermaid.html`

**优化前**: Mermaid.js (214.8 KiB) 在页面加载时立即请求，阻塞渲染 2,860 毫秒

**优化后**:
- 使用 `window.addEventListener('load')` 延迟加载
- 在页面完全加载后才加载 Mermaid
- 不影响初始渲染性能

**预计节省**: ~2,860 毫秒

### 5. 外部资源本地化 (最新优化)

**文件**: 
- `data/external.yaml` - 配置文件
- `static/lib/vibrant/` - Vibrant.js 本地副本
- `static/lib/photoswipe/` - PhotoSwipe 本地副本
- `layouts/partials/helper/external.html` - 模板修复

**优化前**: 
- Vibrant.js (41.3 KiB) 从 unpkg.com 加载，耗时 4,450 毫秒
- PhotoSwipe JS (31.1 KiB) 从 unpkg.com 加载，耗时 2,060 毫秒
- PhotoSwipe CSS (16.5 KiB) 从 unpkg.com 加载，耗时 1,630 毫秒
- 外部 CDN 存在高延迟问题
- 模板未正确处理 `async` 和 CSS 延迟加载属性

**优化后**:
1. **资源本地化**:
   - 下载所有 Vibrant 和 PhotoSwipe 资源到 `static/lib/`
   - 包含所有依赖的图片资源（default-skin.png, default-skin.svg, preloader.gif）
   - 避免外部 CDN 的 DNS 查询、TCP 连接和 TLS 握手延迟
   
2. **模板修复** (`layouts/partials/helper/external.html`):
   - 添加对 `async` 属性的支持
   - 添加对 CSS `media` 属性的支持
   - 添加对 CSS `onload` 属性的支持
   
3. **配置更新**:
   - JS 文件使用 `async: true`，不阻塞 HTML 解析
   - CSS 使用 media query 技巧实现异步加载：
     ```yaml
     media: print
     onload: this.media='all'
     ```
   - 移除 CDN 的 integrity 检查（本地资源不需要）

**预计节省**: ~6,510 毫秒（完全避免 unpkg.com 的延迟）

## 总体效果预估

| 资源 | 优化前耗时 | 优化策略 | 预计改善 |
|------|-----------|---------|---------|
| Vibrant.js | 4,450ms | 本地化 + 异步加载 | 减少 4,000ms+ |
| PhotoSwipe JS | 2,060ms | 本地化 + 异步加载 | 减少 1,800ms+ |
| PhotoSwipe CSS | 1,630ms | 本地化 + 异步加载 | 完全移出关键路径 |
| Waline CSS | 3,440ms | 懒加载 | 完全移出关键路径 |
| Mermaid.js | 2,860ms | 延迟加载 | 完全移出关键路径 |

**总计预计改善**: 从 840ms+ 渲染阻塞减少到接近 0ms

**关键改进**:
- 消除了 unpkg.com 的 4.5 秒延迟
- 所有阻塞渲染的资源完全移出关键路径
- 本地资源加载速度显著提升
- 减少外部依赖，提高可靠性

## 验证方法

1. **使用 Google PageSpeed Insights**
   ```
   https://pagespeed.web.dev/
   ```
   检查 "Eliminate render-blocking resources" 指标

2. **使用 Chrome DevTools**
   - 打开 Network 面板
   - 勾选 "Disable cache"
   - 刷新页面
   - 查看 Waterfall 图，确认资源加载顺序

3. **使用 WebPageTest**
   ```
   https://www.webpagetest.org/
   ```
   查看 Start Render 和 LCP 时间

## 注意事项

1. **浏览器兼容性**: Intersection Observer API 在现代浏览器中支持良好，已提供降级方案
2. **用户体验**: 评论区懒加载可能导致首次滚动到评论区时有短暂延迟，但不影响整体体验
3. **缓存策略**: CDN 资源会被浏览器缓存，二次访问时性能更佳

## 后续优化建议

1. ✅ **自托管关键资源**: 已完成 Vibrant 和 PhotoSwipe 的本地化
2. **Waline 评论系统本地化**: 考虑将 Waline CSS 下载到本地
3. **使用 HTTP/2 Server Push**: 如果服务器支持，可以推送关键 CSS
4. **实施 Critical CSS**: 提取首屏关键 CSS 内联到 HTML
5. **图片优化**: 使用 WebP 格式和懒加载
6. **字体优化**: 使用 font-display: swap 和字体子集化

## 部署步骤

1. 确保所有修改已保存
2. 重新构建 Hugo 站点：
   ```bash
   hugo --minify
   ```
3. 部署到生产环境
4. 清除 CDN 缓存（如果使用）
5. 使用上述验证方法测试性能改善

## 回滚方案

如果遇到问题，可以通过 Git 回滚到之前的版本：
```bash
# 回滚配置和模板文件
git checkout HEAD~1 -- layouts/partials/head/
git checkout HEAD~1 -- layouts/partials/comments/provider/waline.html
git checkout HEAD~1 -- layouts/partials/helper/mermaid.html
git checkout HEAD~1 -- layouts/partials/helper/external.html
git checkout HEAD~1 -- data/external.yaml

# 删除本地化的资源（如需恢复使用 CDN）
rm -rf static/lib/vibrant static/lib/photoswipe
```

## 本地化资源清单

已下载到本地的文件：
- `static/lib/vibrant/vibrant.min.js` (58K)
- `static/lib/photoswipe/photoswipe.min.js` (32K)
- `static/lib/photoswipe/photoswipe-ui-default.min.js` (9.7K)
- `static/lib/photoswipe/photoswipe.css` (4.1K)
- `static/lib/photoswipe/dist/default-skin/default-skin.css` (12K)
- `static/lib/photoswipe/dist/default-skin/default-skin.png` (547B)
- `static/lib/photoswipe/dist/default-skin/default-skin.svg` (1.6K)
- `static/lib/photoswipe/dist/default-skin/preloader.gif` (866B)
